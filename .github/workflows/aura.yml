name: Python package

on:
  - push
  - workflow_dispatch

jobs:
  setup:
    name: Integration Tests
    runs-on: ubuntu-latest
    outputs:
      instanceid: ${{ steps.create.outputs.instanceid }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: "3.12.1"

      - name: Display Python version
        run: python -c "import sys; print(sys.version)"

      - name: Install Aura CLI
        run: python -m pip install --upgrade aura-cli

      - name: Apply Credentials
        run: aura credentials add --name aura --client-id ${{ secrets.AURA_CLIENT_ID }} --client-secret ${{ secrets.AURA_CLIENT_SECRET }} --use

      - name: Create Instance
        id: create
        run: |
          instanceid=$(aura instances create --name AuraIntegrationTests --cloud-provider ${{ secrets.AURA_CLOUD_PROVIDER }} --region ${{ secrets.AURA_REGION }} --type professional-db --tenant-id ${{ secrets.AURA_TENANT_ID }} | jq -r '.id')
          echo $instanceid
          echo "instanceid=$instanceid" >> $GITHUB_OUTPUT

      - name: Exists?
        run: aura instances get --instance-id ${{ steps.create.outputs.instanceid }}

      - name: Wait for instance
        run: |
          while true; do
            dbstatus=$(aura instances get --instance-id ${{ steps.create.outputs.instanceid }} | jq -r '.status')
            if [ "$dbstatus" = "running" ]; then
                echo "Status is running. Continuing..."
                break
            else
                echo "Status is $dbstatus. Waiting..."
                sleep 20
            fi
          done

  tests:
    name: Tests
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20.9.0"
      - name: Run Tests
        run: |
          echo "${{ needs.setup.outputs.instanceid }}"
          echo "Running tests..."
          echo "Tests completed..."

  teardown:
    name: Teardown
    runs-on: ubuntu-latest
    needs:
      - setup
      - tests
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: "3.12.1"

      - name: Install Aura CLI
        run: python -m pip install --upgrade aura-cli

      - name: Apply Credentials
        run: aura credentials add --name aura --client-id ${{ secrets.AURA_CLIENT_ID }} --client-secret ${{ secrets.AURA_CLIENT_SECRET }} --use

      - name: Delete Instance
        run: aura instances delete --instance-id ${{ needs.setup.outputs.instanceid }} --yes
